version: '3.9'

name: dti

networks:
  internal:
    external: false
  web:
    external: true

services:
  api:
    #   image: registry.qvineox.ru/masters/domain-threat-intelligence-hub/domain_threat_intel:stage
    build:
      context: ./domain-threat-intelligence-api
      dockerfile: scripts/rgs/Dockerfile
    container_name: domain_threat_intel_api
    hostname: dti_api
    restart: unless-stopped
    env_file:
      - .env
    environment:
      db_host: $DB_HOST
      db_port: $DB_PORT
      db_user: $DB_USER
      db_pass: $DB_PASS
      db_name: $DB_NAME
      db_timezone: $DB_TZ

      scheduling_rate: 1000
      scheduling_limit: 100
      scheduling_tls: $GRPC_TLS

      http_host: 0.0.0.0
      http_port: 80

      http_api_path: $HTTP_API_PATH

      http_swagger_enabled: $HTTP_SWAGGER_ENABLED
      http_swagger_host: $HTTP_SWAGGER_HOST
      http_swagger_version: $HTTP_SWAGGER_VERSION

      http_security_tls: $HTTP_SECURITY_TLS
      http_security_origins: $HTTP_SECURITY_ORIGINS
      http_security_domain: $HTTP_SECURITY_DOMAIN

      log_level: info
    networks:
      - web
      - internal
    volumes:
      - ./api_configs:/configs
    labels:
      - traefik.enable=true
      - traefik.http.routers.dti_api.service=dti_api
      - traefik.http.routers.dti_api.rule=Host(`domain-threat-intel.rgs.ru`) && (PathPrefix(`/api`) || PathPrefix(`/swagger`))
      - traefik.http.routers.dti_api.tls=true
      - traefik.http.routers.dti_api.entrypoints=websecure
      - traefik.http.services.dti_api.loadbalancer.server.port=80

  hub:
    build:
      context: ./domain-threat-intelligence-hub
      dockerfile: scripts/rgs/Dockerfile
    container_name: domain_threat_intel_hub
    hostname: dti_hub
    restart: unless-stopped
    networks:
      - web
    labels:
      - traefik.enable=true
      - traefik.http.routers.dti_hub.service=dti_hub
      - traefik.http.routers.dti_hub.rule=Host(`domain-threat-intel.rgs.ru`)
      - traefik.http.routers.dti_hub.tls=true
      - traefik.http.routers.dti_hub.entrypoints=websecure
      - traefik.http.services.dti_hub.loadbalancer.server.port=80

  agent-01:
    build:
      context: ./domain-threat-intelligence-agent
      dockerfile: scripts/rgs/Dockerfile
    container_name: domain_threat_intel_agent_01
    hostname: dti_agent_01
    restart: unless-stopped
    env_file:
      - .env
    environment:
      grpc_host: $GRPC_HOST
      grpc_port: 2814
      grpc_tls: $GRPC_TLS

      http_clients_proxy: $HTTP_PROXY

      oss_vt_apikey: $VT_API_KEY
      oss_ipqs_apikey: $IPQS_API_KEY
      oss_shodan_apikey: $SHODAN_API_KEY
      oss_crowdsec_apikey: $CROWDSEC_API_KEY
      oss_ipwhois_apikey:
    networks:
      - internal
    labels:
      - traefik.enable=false

  agent-02:
    build:
      context: ./domain-threat-intelligence-agent
      dockerfile: scripts/rgs/Dockerfile
    container_name: domain_threat_intel_agent_02
    hostname: dti_agent_02
    restart: unless-stopped
    env_file:
      - .env
    environment:
      grpc_host: $GRPC_HOST
      grpc_port: 2815
      grpc_tls: $GRPC_TLS

      http_clients_proxy: $HTTP_PROXY

      oss_vt_apikey: $VT_API_KEY
      oss_ipqs_apikey: $IPQS_API_KEY
      oss_shodan_apikey: $SHODAN_API_KEY
      oss_crowdsec_apikey: $CROWDSEC_API_KEY
      oss_ipwhois_apikey:
    networks:
      - internal
    labels:
      - traefik.enable=false